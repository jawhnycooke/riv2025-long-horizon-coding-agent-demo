# GitHub Actions workflow to trigger ECS Worker via Step Functions
#
# This workflow is part of the Two-Container ECS Architecture:
# - Orchestrator: Long-running ECS service that polls GitHub and invokes workers
# - Worker: On-demand ECS task that builds features from issues
#
# This workflow provides an alternative trigger path (besides the orchestrator)
# for manual builds or when the orchestrator is not running.

name: ECS Agent Builder

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to build'
        required: true
        type: number
      force_rebuild:
        description: 'Force rebuild even if already building'
        required: false
        type: boolean
        default: false

# Prevent concurrent builds of the same issue
concurrency:
  group: ecs-agent-build-${{ github.event.inputs.issue_number }}
  cancel-in-progress: false

permissions:
  issues: write
  contents: read
  actions: write

env:
  AWS_REGION: us-west-2
  # These should be set as repository variables
  # STATE_MACHINE_ARN: Set via vars.STATE_MACHINE_ARN
  # ECS_CLUSTER_NAME: Set via vars.ECS_CLUSTER_NAME

jobs:
  # Check if the issue is approved and ready to build
  check-approval:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      issue_number: ${{ steps.check.outputs.issue_number }}
      issue_title: ${{ steps.check.outputs.issue_title }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install PyGithub

      - name: Check issue approval status
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.inputs.issue_number }}
          FORCE_REBUILD: ${{ github.event.inputs.force_rebuild }}
          AUTHORIZED_APPROVERS: ${{ vars.AUTHORIZED_APPROVERS }}
        run: |
          python << 'EOF'
          import os
          from github import Github

          _approvers_env = os.environ.get("AUTHORIZED_APPROVERS", "")
          AUTHORIZED_APPROVERS = set(a.strip() for a in _approvers_env.split(",") if a.strip())
          LABEL_BUILDING = "agent-building"

          force_rebuild = os.environ.get("FORCE_REBUILD", "false").lower() == "true"

          gh = Github(os.environ["GITHUB_TOKEN"])
          repo = gh.get_repo(os.environ["GITHUB_REPOSITORY"])

          issue_number = os.environ.get("ISSUE_NUMBER")
          if not issue_number:
              print("No issue number provided")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("should_build=false\n")
              exit(0)

          issue = repo.get_issue(int(issue_number))

          # Check if issue is still open
          if issue.state != 'open':
              print(f"Issue #{issue_number} is closed - skipping")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("should_build=false\n")
              exit(0)

          # Check if already building (unless force_rebuild)
          labels = [l.name for l in issue.labels]
          if LABEL_BUILDING in labels and not force_rebuild:
              print(f"Issue #{issue_number} is already being built")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("should_build=false\n")
              exit(0)

          if "agent-complete" in labels and not force_rebuild:
              print(f"Issue #{issue_number} is already complete")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("should_build=false\n")
              exit(0)

          # Check for staff approval (rocket reaction)
          approved = False
          for reaction in issue.get_reactions():
              if reaction.content == "rocket" and reaction.user.login in AUTHORIZED_APPROVERS:
                  approved = True
                  break

          if not approved:
              print(f"Issue #{issue_number} not approved by staff")
              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write("should_build=false\n")
              exit(0)

          # Output issue details
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write("should_build=true\n")
              f.write(f"issue_number={issue_number}\n")
              title = issue.title.replace('\n', ' ')
              f.write(f"issue_title={title}\n")

          EOF

  # Claim the issue and start the worker
  start-worker:
    needs: check-approval
    if: needs.check-approval.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ORCHESTRATOR_ROLE_ARN }}
          role-duration-seconds: 3600

      - name: Claim issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-approval.outputs.issue_number }}
        run: |
          gh issue edit $ISSUE_NUMBER --add-label "agent-building" --repo $GITHUB_REPOSITORY

          gh issue comment $ISSUE_NUMBER --repo $GITHUB_REPOSITORY --body "ðŸ¤– **ECS Agent Build Started**

          Workflow: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          Started: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          The worker container is starting. Progress will be posted here.

          Commits will be pushed to branch \`agent-runtime\`."

      - name: Start Step Functions execution
        id: start-execution
        env:
          ISSUE_NUMBER: ${{ needs.check-approval.outputs.issue_number }}
          STATE_MACHINE_ARN: ${{ vars.STATE_MACHINE_ARN }}
          PROVIDER: ${{ vars.PROVIDER || 'anthropic' }}
          ENVIRONMENT: ${{ vars.ENVIRONMENT || 'reinvent' }}
        run: |
          if [ -z "$STATE_MACHINE_ARN" ]; then
            echo "ERROR: STATE_MACHINE_ARN not configured"
            exit 1
          fi

          EXECUTION_NAME="issue-${ISSUE_NUMBER}-$(date +%Y%m%d%H%M%S)"

          EXECUTION_ARN=$(aws stepfunctions start-execution \
            --state-machine-arn "$STATE_MACHINE_ARN" \
            --name "$EXECUTION_NAME" \
            --input "{
              \"issue_number\": $ISSUE_NUMBER,
              \"github_repo\": \"$GITHUB_REPOSITORY\",
              \"provider\": \"$PROVIDER\",
              \"environment\": \"$ENVIRONMENT\"
            }" \
            --query 'executionArn' \
            --output text)

          echo "execution_arn=$EXECUTION_ARN" >> $GITHUB_OUTPUT
          echo "execution_name=$EXECUTION_NAME" >> $GITHUB_OUTPUT

          echo "Started Step Functions execution: $EXECUTION_ARN"

      - name: Post execution link
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ needs.check-approval.outputs.issue_number }}
          EXECUTION_ARN: ${{ steps.start-execution.outputs.execution_arn }}
        run: |
          # Extract execution URL components
          REGION=$(echo $EXECUTION_ARN | cut -d: -f4)
          ENCODED_ARN=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$EXECUTION_ARN', safe=''))")

          gh issue comment $ISSUE_NUMBER --repo $GITHUB_REPOSITORY --body "ðŸ“Š **Step Functions Execution Started**

          [View Execution](https://${REGION}.console.aws.amazon.com/states/home?region=${REGION}#/executions/details/${ENCODED_ARN})

          The worker will:
          1. Clone the repository
          2. Build the feature from this issue
          3. Run tests
          4. Push commits to \`agent-runtime\` branch

          Status updates will be posted as the build progresses."

      - name: Write job summary
        env:
          ISSUE_NUMBER: ${{ needs.check-approval.outputs.issue_number }}
          ISSUE_TITLE: ${{ needs.check-approval.outputs.issue_title }}
          EXECUTION_ARN: ${{ steps.start-execution.outputs.execution_arn }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOFSUM
          ## ECS Agent Build Started

          | Field | Value |
          |-------|-------|
          | Issue | #${ISSUE_NUMBER} |
          | Title | ${ISSUE_TITLE} |
          | Execution ARN | \`${EXECUTION_ARN}\` |

          :white_check_mark: Worker container started via Step Functions
          EOFSUM
