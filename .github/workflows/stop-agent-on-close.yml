name: Stop Agent on Issue Close

on:
  issues:
    types: [closed]

permissions:
  issues: write
  contents: read

env:
  AWS_REGION: us-west-2

jobs:
  stop-worker:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Only run for issues that had agent activity
    if: |
      contains(github.event.issue.labels.*.name, 'agent-building') ||
      contains(github.event.issue.labels.*.name, 'agent-complete') ||
      contains(github.event.issue.labels.*.name, 'tests-failed')

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ORCHESTRATOR_ROLE_ARN }}
          role-duration-seconds: 900

      - name: Stop running Step Functions executions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          STATE_MACHINE_ARN: ${{ vars.STATE_MACHINE_ARN }}
        run: |
          if [ -z "$STATE_MACHINE_ARN" ]; then
            echo "STATE_MACHINE_ARN not configured, skipping Step Functions cleanup"
            exit 0
          fi

          echo "Looking for running executions for issue #$ISSUE_NUMBER..."

          # Find running executions that match this issue number
          EXECUTIONS=$(aws stepfunctions list-executions \
            --state-machine-arn "$STATE_MACHINE_ARN" \
            --status-filter RUNNING \
            --query "executions[?contains(name, 'issue-${ISSUE_NUMBER}-')].executionArn" \
            --output text)

          if [ -z "$EXECUTIONS" ]; then
            echo "No running executions found for issue #$ISSUE_NUMBER"
          else
            for EXEC_ARN in $EXECUTIONS; do
              echo "Stopping execution: $EXEC_ARN"
              aws stepfunctions stop-execution \
                --execution-arn "$EXEC_ARN" \
                --cause "Issue #$ISSUE_NUMBER was closed" || true
            done
          fi

      - name: Remove agent-building label
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # Remove the agent-building label if present
          gh issue edit $ISSUE_NUMBER --remove-label "agent-building" --repo $GITHUB_REPOSITORY 2>/dev/null || true

      - name: Post cleanup comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          gh issue comment $ISSUE_NUMBER --repo $GITHUB_REPOSITORY --body "ðŸ›‘ **Issue Closed - Build Stopped**

          Any running worker builds for this issue have been stopped.

          ---
          *Automated by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
