# Worker Container
# Full build environment for executing GitHub issue builds
#
# Responsibilities:
# - Clone repository and set up git branches
# - Build React applications following BUILD_PLAN.md
# - Take screenshots using Playwright
# - Run tests and verify implementations
# - Commit and push changes to git
# - Exit with success/failure code

FROM public.ecr.aws/docker/library/python:3.12-slim

# Install system dependencies for Playwright, git operations, and React builds
# Also includes Chromium dependencies for Playwright headless browser
RUN apt-get update && apt-get install -y \
    git \
    curl \
    nodejs \
    npm \
    procps \
    lsof \
    ripgrep \
    jq \
    net-tools \
    findutils \
    chromium \
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libxshmfence1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy worker application code
COPY claude_code_agent.py .
COPY src/ ./src/
COPY prompts/ ./prompts/
COPY frontend-scaffold-template/ ./frontend-scaffold-template/
COPY prompt_template.txt .
COPY state_management.txt .

# Install Claude Code CLI (required by Claude Agent SDK)
RUN npm install -g @anthropic-ai/claude-code

# Install Playwright for browser automation (screenshots, testing)
RUN npx playwright install chromium

# Create workspace directories
RUN mkdir -p /app/workspace /projects

# Environment variables
ENV PYTHONUNBUFFERED=1
ENV WORKER_MODE=true

# The worker is invoked with environment variables:
# - ISSUE_NUMBER: GitHub issue number to build
# - GITHUB_REPOSITORY: Target repo (e.g., "owner/repo")
# - PROVIDER: "anthropic" or "bedrock"
# - ENVIRONMENT: Environment name for secrets lookup

# Run the worker in worker mode
CMD ["python", "claude_code_agent.py", "--worker-mode"]
