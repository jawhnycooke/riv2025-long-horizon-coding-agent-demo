version: '3.8'

# Two-Container Architecture for Local Development
# - orchestrator: Manages GitHub issues, invokes workers
# - worker: Builds React applications from issues

services:
  # ==========================================================================
  # Orchestrator Service (Long-running)
  # ==========================================================================
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.orchestrator
    container_name: claude-code-orchestrator

    environment:
      # GitHub configuration
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AUTHORIZED_APPROVERS=${AUTHORIZED_APPROVERS}

      # Claude API configuration
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PROVIDER=${PROVIDER:-anthropic}

      # Step Functions (for ECS deployment, use mock for local)
      - STATE_MACHINE_ARN=${STATE_MACHINE_ARN:-local-mock}

      # Environment
      - ENVIRONMENT=${ENVIRONMENT:-local}
      - POLL_INTERVAL_SECONDS=${POLL_INTERVAL_SECONDS:-300}
      - AWS_REGION=${AWS_REGION:-us-west-2}

    # Resource limits (lightweight)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 1G

    restart: unless-stopped

    healthcheck:
      # Use simple print instead of importing orchestrator to avoid PYTHONPATH issues
      test: ["CMD", "python", "-c", "print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================================================
  # Worker Service (On-demand)
  # ==========================================================================
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: claude-code-worker

    # Worker runs via harness-based entry point (preferred)
    # Environment variables are passed to worker_main.py
    command: ["python", "worker_main.py"]

    # Mount for EFS simulation
    volumes:
      - ./projects:/projects

    environment:
      # GitHub configuration
      - GITHUB_REPOSITORY=${GITHUB_REPOSITORY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}

      # Claude API configuration
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PROVIDER=${PROVIDER:-anthropic}

      # Worker-specific
      - ISSUE_NUMBER=${ISSUE_NUMBER:-1}
      - WORKER_MODE=true
      - ENVIRONMENT=${ENVIRONMENT:-local}
      - AWS_REGION=${AWS_REGION:-us-west-2}

    # Network for local development
    # Note: 'host' mode doesn't work on macOS, use 'bridge' (default) instead
    # The worker accesses localhost via host.docker.internal on macOS/Windows
    network_mode: bridge

    # Resource limits (full build environment)
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 8G
        reservations:
          cpus: '2.0'
          memory: 4G

    # Don't restart - workers are one-shot
    restart: "no"
